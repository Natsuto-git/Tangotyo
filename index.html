<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å˜èªå¸³ã‚¢ãƒ—ãƒªï¼ˆWebç‰ˆï¼‰</title>
    <style>
      :root {
        --bg: #0b0f19;
        --panel: #121a2a;
        --text: #e8eefc;
        --muted: #a9b4d0;
        --border: rgba(232, 238, 252, 0.12);
        --accent: #7aa2ff;
        --bad: #ff6b6b;
        --good: #51cf66;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 700px at 10% 10%, rgba(122, 162, 255, 0.25), transparent 55%),
                    radial-gradient(1000px 600px at 90% 20%, rgba(81, 207, 102, 0.18), transparent 60%),
                    var(--bg);
        color: var(--text);
      }
      a { color: var(--accent); }
      .wrap { max-width: 1240px; margin: 0 auto; padding: 20px; }
      @media (min-width: 900px) { .wrap { padding: 36px; } }
      @media (min-width: 1200px) { .wrap { padding: 44px; } }

      h1 { font-size: 22px; margin: 0 0 10px; }
      @media (min-width: 900px) { h1 { font-size: 28px; margin: 0 0 14px; } }
      .sub { color: var(--muted); margin: 0 0 18px; font-size: 14px; line-height: 1.6; }

      .grid { display: grid; grid-template-columns: 1fr; gap: 18px; max-width: 700px; margin: 0 auto; }

      .card, .panel {
        background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
      }
      @media (min-width: 900px) { .card, .panel { padding: 18px; } }

      textarea {
        width: 100%;
        min-height: 220px;
        resize: vertical;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.22);
        color: var(--text);
        padding: 12px;
        line-height: 1.55;
        font-size: 15px;
      }
      @media (min-width: 900px) { textarea { min-height: 280px; } }

      .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
      button, select, input[type="text"] {
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.24);
        color: var(--text);
        padding: 12px 14px;
        font-weight: 700;
      }
      button { cursor: pointer; }
      button:hover { border-color: rgba(122,162,255,0.6); }
      button:disabled { opacity: 0.45; cursor: not-allowed; }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--muted);
        font-size: 12px;
      }

      .trainer { display: grid; gap: 12px; }
      .face {
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 16px;
        background: rgba(0,0,0,0.2);
      }
      @media (min-width: 900px) { .face { padding: 18px; } }
      .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
      .big { font-size: 22px; font-weight: 900; letter-spacing: 0.2px; white-space: pre-wrap; }
      @media (min-width: 900px) { .big { font-size: 26px; } }
      .small { font-size: 16px; color: var(--text); opacity: 0.95; white-space: pre-wrap; }
      .example { margin-top: 8px; color: var(--muted); white-space: pre-wrap; }
      .hint { font-size: 12px; color: var(--muted); }

      .tap { user-select: none; -webkit-user-select: none; }
      .tap:hover { border-color: rgba(122,162,255,0.6); }

      .actions { display: flex; gap: 14px; align-items: center; justify-content: center; margin-top: 12px; }
      .judge {
        width: 84px;
        height: 64px;
        border-radius: 16px;
        font-size: 28px;
        font-weight: 900;
      }
      .judge.good { border-color: rgba(81,207,102,0.45); background: rgba(81,207,102,0.10); }
      .judge.bad { border-color: rgba(255,107,107,0.45); background: rgba(255,107,107,0.10); }
      .markBtn { min-width: 56px; height: 46px; border-radius: 12px; font-size: 18px; font-weight: 900; }

      .footer { margin-top: 14px; color: var(--muted); font-size: 12px; line-height: 1.5; }
      .banner {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(122,162,255,0.10);
        color: var(--text);
        font-size: 13px;
        line-height: 1.5;
        display: none;
      }

      /* list modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 14px;
      }
      .modal .modalCard {
        width: min(980px, 100%);
        max-height: min(82vh, 900px);
        overflow: auto;
        background: #0f1626;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; vertical-align: top; }
      th { color: var(--muted); font-weight: 800; }
      .tag { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); display: inline-block; }
      .tag.good { color: var(--good); border-color: rgba(81,207,102,0.35); }
      .tag.bad { color: var(--bad); border-color: rgba(255,107,107,0.35); }

      /* iOS/Safari click safety */
      button { touch-action: manipulation; pointer-events: auto; }
      code { color: rgba(232,238,252,0.95); }

      /* Header & view toggle */
      .headerRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        max-width: 700px;
        margin: 0 auto;
      }
      .mobileViewToggle {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.4);
        color: var(--text);
        padding: 8px 14px;
        font-size: 13px;
        cursor: pointer;
      }
      .mobileViewToggle:hover {
        border-color: rgba(122,162,255,0.6);
      }
      .mobileViewToggle:active {
        background: rgba(0, 0, 0, 0.6);
      }
      .sub {
        max-width: 700px;
        margin: 0 auto 18px;
      }
      #deckSection {
        max-width: 700px;
        margin: 0 auto 18px;
      }
      @media (max-width: 600px) {
        .wrap { padding: 16px; }
        .headerRow h1 { font-size: 18px; }
        .mobileViewToggle {
          padding: 6px 10px;
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="headerRow">
        <h1>å˜èªå¸³ã‚¢ãƒ—ãƒªï¼ˆWebç‰ˆï¼‰</h1>
        <button type="button" id="mobileViewToggle" class="mobileViewToggle" aria-label="è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ">
          â˜° å˜èªå¸³
        </button>
      </div>
      <p class="sub">
        Obsidianã®è¡¨ï¼ˆ<code>| å˜èª | æ„å‘³ | ä¾‹æ–‡ |</code>ï¼‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ â†’ <b>Load</b>ã€‚
        ç«¯æœ«ã”ã¨ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageï¼‰ã€‚
      </p>

      <div class="panel" id="deckSection" style="margin-bottom: 18px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div class="row" style="align-items: center; gap: 12px;">
            <span class="pill">ğŸ“š ãƒ‡ãƒƒã‚­é¸æŠ</span>
            <select id="deckSelect" style="min-width: 200px; padding: 10px 14px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.24); color: var(--text); font-size: 14px;">
              <optgroup label="ğŸŒ èªå­¦å­¦ç¿’">
                <option value="english">è‹±èª</option>
                <option value="french">ãƒ•ãƒ©ãƒ³ã‚¹èª</option>
                <option value="chinese">ä¸­å›½èª</option>
              </optgroup>
              <optgroup label="ğŸ—¾ å…¨å›½é€šè¨³æ¡ˆå†…å£«">
                <option value="guide-en">è‹±èª</option>
                <option value="guide-japan">æ—¥æœ¬åœ°ç†</option>
                <option value="guide-history">æ—¥æœ¬æ­´å²ï¼ˆå…¨ä½“ï¼‰</option>
                <option value="guide-general">ä¸€èˆ¬å¸¸è­˜</option>
                <option value="guide-practice">é€šè¨³æ¡ˆå†…ã®å®Ÿå‹™</option>
                <option value="guide-oral">å£è¿°</option>
              </optgroup>
              <optgroup label="ğŸ“œ æ—¥æœ¬æ­´å²ï¼ˆæ™‚ä»£åˆ¥ï¼‰">
                <option value="history-ancient">å¤ä»£ï¼ˆã€œ794å¹´ï¼‰</option>
                <option value="history-heian">å¹³å®‰æ™‚ä»£</option>
                <option value="history-kamakura">éŒå€‰æ™‚ä»£</option>
                <option value="history-muromachi">å®¤ç”ºæ™‚ä»£</option>
                <option value="history-azuchi">å®‰åœŸæ¡ƒå±±æ™‚ä»£</option>
                <option value="history-edo">æ±Ÿæˆ¸æ™‚ä»£</option>
                <option value="history-modern">è¿‘ç¾ä»£</option>
              </optgroup>
            </select>
          </div>
          <span class="pill" id="deckStatusPill">0æšä¿å­˜</span>
        </div>
      </div>

      <div class="grid">
        <div class="panel" id="inputSection">
          <div class="row" style="justify-content: space-between; margin-bottom: 10px;">
            <div class="row">
              <button type="button" id="loadBtn">Load</button>
              <button type="button" id="saveBtn" title="ä»Šã®å…¥åŠ›å†…å®¹ã‚’ä¿å­˜">Save</button>
              <button type="button" id="clearSavedBtn" title="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™">Clear saved</button>
            </div>
            <span class="pill" id="statusPill">0æš</span>
          </div>
          <textarea id="input" spellcheck="false" placeholder="ä¾‹ï¼ˆMarkdownè¡¨ï¼‰:
| å˜èª | æ„å‘³ | ä¾‹æ–‡ |
|---|---|---|
| hello | ã“ã‚“ã«ã¡ã¯ | Hello, nice to meet you. |
"></textarea>
          <div class="footer">ãƒ‘ãƒ¼ã‚¹å¯¾è±¡ã¯ <b>æœ€åˆã®3åˆ—</b>ï¼ˆå˜èª / æ„å‘³ / ä¾‹æ–‡ï¼‰ã§ã™ã€‚</div>
        </div>

        <div class="card" id="trainerSection">
          <div class="row" style="justify-content: space-between; margin-bottom: 10px;">
            <div class="row">
              <button type="button" id="listBtn">å˜èªä¸€è¦§</button>
              <button type="button" id="restartBtn">æœ€åˆã‹ã‚‰</button>
              <button type="button" id="retryWrongBtn">ãƒŸã‚¹ã ã‘ã‚‚ã†ä¸€å›</button>
            </div>
            <div class="row">
              <select id="modeSelect" title="å‡ºé¡Œæ–¹å‘">
                <option value="wordToMeaning">å˜èª â†’ æ„å‘³</option>
                <option value="meaningToWord">æ„å‘³ â†’ å˜èª</option>
              </select>
              <button type="button" id="shuffleBtn">Shuffle</button>
            </div>
          </div>

          <div class="trainer">
            <div class="face">
              <div class="label">è¡¨ï¼ˆå•é¡Œï¼‰</div>
              <div class="big" id="front">Load ã—ã¦é–‹å§‹</div>
              <div class="hint" id="frontHint"></div>
            </div>

            <div class="face tap" id="backBox" role="button" aria-label="ç­”ãˆã‚’è¡¨ç¤º">
              <div class="label">è£ï¼ˆç­”ãˆï¼‰</div>
              <div class="small" id="back">ï¼ˆã“ã“ã‚’ã‚¿ãƒƒãƒ—ã§ç­”ãˆè¡¨ç¤ºï¼‰</div>
              <div class="example" id="example"></div>
            </div>
          </div>

          <div class="row" style="justify-content: space-between; margin-top: 12px;">
            <span class="pill" id="progressPill">0/0</span>
            <span class="pill" id="summaryPill">â—‹0 / Ã—0 / âœ“0</span>
          </div>

          <div class="actions">
            <button type="button" id="correctBtn" class="judge good">â—‹</button>
            <button type="button" id="wrongBtn" class="judge bad">Ã—</button>
            <button type="button" id="markBtn" class="markBtn">â–¡</button>
          </div>

          <div id="doneBanner" class="banner">å®Œäº†ï¼</div>
          <div class="footer">â—‹/Ã—ã§æ¬¡ã¸ã€‚ç­”ãˆæ ã‚¿ãƒƒãƒ—ã§ç­”ãˆè¡¨ç¤ºã€‚æœ€å¾Œã§å®Œäº†è¡¨ç¤ºã€‚</div>
        </div>
      </div>
    </div>

    <div id="listModal" class="modal">
      <div class="modalCard">
        <div class="row" style="justify-content: space-between; margin-bottom: 10px;">
          <div class="row">
            <span class="pill">å˜èªä¸€è¦§</span>
            <button type="button" id="listToggleWrongBtn">ãƒŸã‚¹ã®ã¿: OFF</button>
          </div>
          <button type="button" id="listCloseBtn">é–‰ã˜ã‚‹</button>
        </div>
        <div class="footer" style="margin-top:0;">å…¨å˜èªã‚’ç¢ºèªã§ãã¾ã™ï¼ˆãƒŸã‚¹ã®ã¿è¡¨ç¤ºã‚‚å¯èƒ½ï¼‰ã€‚</div>
        <div style="height:10px"></div>
        <table>
          <thead>
            <tr>
              <th style="width:90px;">çŠ¶æ…‹</th>
              <th style="width:70px;">âœ“</th>
              <th>å˜èª</th>
              <th>æ„å‘³</th>
              <th>ä¾‹æ–‡</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Tangotyo app initializing...');

        // Storage functions with fallback
        function safeGet(key) {
          try {
            return localStorage.getItem(key) || sessionStorage.getItem(key);
          } catch (e) {
            console.warn('Storage get failed:', e);
            return null;
          }
        }
        function safeSet(key, val) {
          try {
            localStorage.setItem(key, val);
            console.log('Saved to localStorage:', key);
          } catch (e) {
            try {
              sessionStorage.setItem(key, val);
              console.log('Saved to sessionStorage:', key);
            } catch (e2) {
              console.warn('Storage set failed:', e2);
            }
          }
        }
        function safeRemove(key) {
          try {
            localStorage.removeItem(key);
          } catch (e) {
            try {
              sessionStorage.removeItem(key);
            } catch (e2) {
              console.warn('Storage remove failed:', e2);
            }
          }
        }

      function normalizeCell(s) {
        return (s ?? "")
          .replace(/<br\s*\/?>/gi, "\n")
          .replace(/\s+/g, " ")
          .trim();
      }
      function makeId(word, meaning, ex) { return [word, meaning, ex || ""].join("||"); }
      function parseInput(text) {
        text = (text || "").replace(/ï½œ/g, "|");
        const lines = (text || "").split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
        const out = [];
        for (const line of lines) {
          if (line.includes("|")) {
            const stripped = line.replace(/^\|/, "").replace(/\|$/, "");
            const parts = stripped.split("|").map((p) => p.trim());
            if (parts.length < 2) continue;
            if (parts.every((p) => /^-+$/.test(p) || /^:?-+:?$/.test(p))) continue;
            if (parts[0] === "å˜èª" && (parts[1] === "æ„å‘³" || parts[1] === "æ„å‘³ï¼ˆæ—¥æœ¬èªï¼‰")) continue;
            const [w, m, ex] = parts;
            const word = normalizeCell(w);
            const meaning = normalizeCell(m);
            const exampleText = normalizeCell(ex);
            if (!word || !meaning) continue;
            out.push({ word, meaning, example: exampleText, id: makeId(word, meaning, exampleText) });
            continue;
          }
          if (line.includes("\\t")) {
            const [w, m, ex] = line.split("\\t").map((p) => p.trim());
            const word = normalizeCell(w);
            const meaning = normalizeCell(m);
            const exampleText = normalizeCell(ex);
            if (!word || !meaning) continue;
            out.push({ word, meaning, example: exampleText, id: makeId(word, meaning, exampleText) });
          }
        }
        return out;
      }
      function shuffleInPlace(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }
      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      const el = (id) => {
        const element = document.getElementById(id);
        if (!element) {
          console.error('Element not found:', id);
        }
        return element;
      };
      const mobileViewToggle = el("mobileViewToggle");
      const deckSection = document.getElementById("deckSection");
      const inputSection = document.getElementById("inputSection");
      const trainerSection = document.getElementById("trainerSection");

      const deckSelect = el("deckSelect");
      const deckStatusPill = el("deckStatusPill");
      const input = el("input");
      const statusPill = el("statusPill");
      const progressPill = el("progressPill");
      const summaryPill = el("summaryPill");
      const doneBanner = el("doneBanner");

      const front = el("front");
      const back = el("back");
      const example = el("example");
      const backBox = el("backBox");

      const loadBtn = el("loadBtn");
      const saveBtn = el("saveBtn");
      const clearSavedBtn = el("clearSavedBtn");
      const modeSelect = el("modeSelect");
      const shuffleBtn = el("shuffleBtn");

      const correctBtn = el("correctBtn");
      const wrongBtn = el("wrongBtn");
      const markBtn = el("markBtn");

      const restartBtn = el("restartBtn");
      const retryWrongBtn = el("retryWrongBtn");
      const listBtn = el("listBtn");

      const listModal = el("listModal");
      const listCloseBtn = el("listCloseBtn");
      const listToggleWrongBtn = el("listToggleWrongBtn");
      const listBody = el("listBody");

      let STORAGE_KEY = "tangotyo:english:input";
      let MARKS_KEY = "tangotyo:english:marks";

      let cards = [];
      let active = [];
      let pos = 0;
      let revealed = false;
      let correct = new Set();
      let wrong = new Set();
      let marked = new Set();
      let listWrongOnly = false;

      let currentView = "input";

      function applyDeck(key) {
        const k = (key || "").trim() || "default";
        STORAGE_KEY = `tangotyo:${k}:input`;
        MARKS_KEY = `tangotyo:${k}:marks`;
        const saved = safeGet(STORAGE_KEY);
        input.value = saved || "";
        marked = new Set();
        const savedMarks = safeGet(MARKS_KEY);
        if (savedMarks) {
          try { marked = new Set(JSON.parse(savedMarks) || []); } catch (_) {}
        }
        cards = [];
        active = [];
        pos = 0;
        revealed = false;
        correct = new Set();
        wrong = new Set();
        listWrongOnly = false;
        retryWrongBtn.disabled = true;
        setDone(false);
        render();

        // Update deck status pill
        if (deckStatusPill) {
          if (saved && saved.trim()) {
            const tempCards = parseInput(saved);
            deckStatusPill.textContent = `${tempCards.length}æšä¿å­˜`;
          } else {
            deckStatusPill.textContent = `ãƒ‡ãƒ¼ã‚¿ãªã—`;
          }
        }

        // Auto-load saved data
        if (saved && saved.trim()) {
          cards = parseInput(saved);
          rebuildActiveAll();
          resetProgress();
          render();
          statusPill.textContent = `${activeCount()}æš`;
          console.log('Auto-loaded saved data:', cards.length, 'cards');
        }
      }

      function applyMobileView() {
        if (!deckSection || !inputSection || !trainerSection) return;

        if (currentView === "input") {
          deckSection.style.display = "block";
          inputSection.style.display = "block";
          trainerSection.style.display = "none";
          if (mobileViewToggle) mobileViewToggle.textContent = "â˜° å˜èªå¸³ã¸";
        } else {
          deckSection.style.display = "block";
          inputSection.style.display = "none";
          trainerSection.style.display = "block";
          if (mobileViewToggle) mobileViewToggle.textContent = "â˜° å…¥åŠ›ã¸";
        }
      }

      function activeCount() { return active.length; }
      function currentCard() {
        const i = active[pos];
        if (i === undefined) return null;
        return cards[i] || null;
      }
      function updateTop() {
        statusPill.textContent = `${activeCount()}æš`;
        const total = activeCount();
        progressPill.textContent = total ? `${pos + 1}/${total}` : "0/0";
        summaryPill.textContent = `â—‹${correct.size} / Ã—${wrong.size} / âœ“${marked.size}`;
        retryWrongBtn.disabled = wrong.size === 0;
      }
      function setDone(isDone) {
        if (isDone) {
          doneBanner.style.display = "block";
          doneBanner.textContent = `å®Œäº†ï¼ï¼ˆÃ— ${wrong.size}ï¼‰`;
        } else {
          doneBanner.style.display = "none";
        }
      }
      function render() {
        updateTop();
        const c = currentCard();
        if (!c) {
          front.textContent = "ãƒ‡ãƒ¼ã‚¿ãªã—";
          back.textContent = "ï¼ˆã“ã“ã‚’ã‚¿ãƒƒãƒ—ã§ç­”ãˆè¡¨ç¤ºï¼‰";
          example.textContent = "";
          setDone(false);
          return;
        }
        const mode = modeSelect.value;
        const frontText = mode === "meaningToWord" ? c.meaning : c.word;
        const backText = mode === "meaningToWord" ? c.word : c.meaning;
        front.textContent = frontText || "â€”";
        if (revealed) {
          back.textContent = backText || "â€”";
          example.textContent = c.example ? `ä¾‹æ–‡: ${c.example}` : "";
        } else {
          back.textContent = "ï¼ˆã“ã“ã‚’ã‚¿ãƒƒãƒ—ã§ç­”ãˆè¡¨ç¤ºï¼‰";
          example.textContent = "";
        }
        markBtn.textContent = marked.has(c.id) ? "âœ“" : "â–¡";
        setDone(false);
      }

      function rebuildActiveAll() { active = cards.map((_, i) => i); }
      function rebuildActiveWrongOnly() {
        const wrongIds = new Set(wrong);
        active = cards.map((c, i) => [c, i]).filter(([c]) => wrongIds.has(c.id)).map(([, i]) => i);
      }
      function resetProgress() { pos = 0; revealed = false; correct = new Set(); wrong = new Set(); }
      function goNextOrDone() {
        if (pos >= active.length - 1) { setDone(true); return; }
        pos += 1;
        revealed = false;
        render();
      }
      function markResult(isCorrect) {
        const c = currentCard();
        if (!c) return;
        if (isCorrect) { correct.add(c.id); wrong.delete(c.id); }
        else { wrong.add(c.id); correct.delete(c.id); }
        goNextOrDone();
      }
      function toggleMark() {
        const c = currentCard();
        if (!c) return;
        if (marked.has(c.id)) marked.delete(c.id);
        else marked.add(c.id);
        safeSet(MARKS_KEY, JSON.stringify(Array.from(marked)));
        render();
      }

      function openList() {
        if (!cards.length) return;
        listModal.style.display = "flex";
        renderList();
      }
      function closeList() { listModal.style.display = "none"; }
      function renderList() {
        listBody.innerHTML = "";
        const rows = listWrongOnly ? cards.filter((c) => wrong.has(c.id)) : cards;
        for (const c of rows) {
          const tr = document.createElement("tr");
          const state = correct.has(c.id) ? '<span class="tag good">â—‹</span>' : wrong.has(c.id) ? '<span class="tag bad">Ã—</span>' : '<span class="tag">-</span>';
          const chk = marked.has(c.id) ? '<span class="tag good">âœ“</span>' : '<span class="tag">-</span>';
          tr.innerHTML = `
            <td>${state}</td>
            <td>${chk}</td>
            <td>${escapeHtml(c.word)}</td>
            <td>${escapeHtml(c.meaning)}</td>
            <td>${escapeHtml(c.example || "")}</td>
          `;
          listBody.appendChild(tr);
        }
        listToggleWrongBtn.textContent = `ãƒŸã‚¹ã®ã¿: ${listWrongOnly ? "ON" : "OFF"}`;
      }

      // events
      if (deckSelect) {
        deckSelect.addEventListener("change", () => {
          console.log('Deck changed to:', deckSelect.value);
          applyDeck(deckSelect.value);
        });
        console.log('Deck switching events attached');
      } else {
        console.error('Deck select element not found');
      }

      if (mobileViewToggle) {
        mobileViewToggle.addEventListener("click", () => {
          currentView = currentView === "input" ? "trainer" : "input";
          applyMobileView();
        });
      }

      window.addEventListener("resize", applyMobileView);

      if (loadBtn && saveBtn && clearSavedBtn) {
        loadBtn.addEventListener("click", () => {
          console.log('Load button clicked');
          cards = parseInput(input.value);
          console.log('Parsed cards:', cards.length);
          // restore marks for this deck
          marked = new Set();
          const savedMarks = safeGet(MARKS_KEY);
          if (savedMarks) { try { marked = new Set(JSON.parse(savedMarks) || []); } catch (e) { console.warn('Failed to parse marks:', e); } }
          rebuildActiveAll();
          resetProgress();
          render();
          statusPill.textContent = `${activeCount()}æš`;
          // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯Loadå¾Œã«è‡ªå‹•ã§å˜èªå¸³ãƒ“ãƒ¥ãƒ¼ã¸
          if (window.matchMedia("(max-width: 899px)").matches) {
            currentView = "trainer";
            applyMobileView();
          }
        });
        saveBtn.addEventListener("click", () => {
          console.log('Save button clicked');
          safeSet(STORAGE_KEY, input.value || "");
        });
        clearSavedBtn.addEventListener("click", () => {
          console.log('Clear saved button clicked');
          safeRemove(STORAGE_KEY);
        });
      }

      if (backBox && correctBtn && wrongBtn && markBtn) {
        backBox.addEventListener("click", () => {
          console.log('Back box clicked');
          if (!cards.length) return;
          revealed = true;
          render();
        });
        correctBtn.addEventListener("click", () => {
          console.log('Correct button clicked');
          markResult(true);
        });
        wrongBtn.addEventListener("click", () => {
          console.log('Wrong button clicked');
          markResult(false);
        });
        markBtn.addEventListener("click", () => {
          console.log('Mark button clicked');
          toggleMark();
        });
      }

      if (restartBtn && retryWrongBtn && shuffleBtn) {
        restartBtn.addEventListener("click", () => {
          console.log('Restart button clicked');
          if (!cards.length) return;
          rebuildActiveAll();
          resetProgress();
          render();
        });
        retryWrongBtn.addEventListener("click", () => {
          console.log('Retry wrong button clicked');
          if (!cards.length) return;
          if (!wrong.size) return;
          rebuildActiveWrongOnly();
          pos = 0;
          revealed = false;
          render();
        });
        shuffleBtn.addEventListener("click", () => {
          console.log('Shuffle button clicked');
          if (!cards.length) return;
          shuffleInPlace(cards);
          rebuildActiveAll();
          resetProgress();
          render();
        });
      }

      if (listBtn && listCloseBtn && listModal && listToggleWrongBtn) {
        listBtn.addEventListener("click", () => {
          console.log('List button clicked');
          openList();
        });
        listCloseBtn.addEventListener("click", () => {
          console.log('List close button clicked');
          closeList();
        });
        listModal.addEventListener("click", (e) => {
          if (e.target === listModal) {
            console.log('List modal background clicked');
            closeList();
          }
        });
        listToggleWrongBtn.addEventListener("click", () => {
          console.log('List toggle wrong button clicked');
          listWrongOnly = !listWrongOnly;
          renderList();
        });
      }

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.target && (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT')) return;
        console.log('Key pressed:', e.key);
        if (e.key === ' ') { e.preventDefault(); revealed = true; render(); }
        if (e.key === 'ArrowLeft') { /* no-op */ }
        if (e.key === 'o' || e.key === 'O') { if (correctBtn) correctBtn.click(); }
        if (e.key === 'x' || e.key === 'X') { if (wrongBtn) wrongBtn.click(); }
        if (e.key === 'm' || e.key === 'M') { if (markBtn) markBtn.click(); }
      });

        // init: read ?k= and ?data= from URL
        const params = new URLSearchParams(location.search);
        const initial = params.get("k") || (deckSelect ? deckSelect.value : null) || "english";
        const dataParam = params.get("data");

        console.log('Initializing with deck key:', initial);
        if (deckSelect) {
          // Set the select value if it matches an option
          const options = Array.from(deckSelect.options);
          const matchingOption = options.find(opt => opt.value === initial);
          if (matchingOption) {
            deckSelect.value = initial;
          }
        }
        applyDeck(initial);

        // Load data from URL parameter
        if (dataParam && input) {
          try {
            const decodedData = decodeURIComponent(dataParam);
            console.log('Loading data from URL:', decodedData.substring(0, 100) + '...');
            input.value = decodedData;
            // Auto-load if data is provided
            setTimeout(() => {
              if (loadBtn) loadBtn.click();
            }, 100);
          } catch (e) {
            console.warn('Failed to decode URL data:', e);
          }
        }

        console.log('Tangotyo app initialized successfully');
        applyMobileView();

        // Helper function for creating share URLs (available in console)
        window.createShareUrl = function(markdownText, deckName = 'english') {
          const encodedData = encodeURIComponent(markdownText);
          return `${window.location.origin}${window.location.pathname}?k=${encodeURIComponent(deckName)}&data=${encodedData}`;
        };

        console.log('ğŸ’¡ Tip: Use createShareUrl(markdownText, deckName) in console to create share URLs');
      });
    </script>
  </body>
</html>


